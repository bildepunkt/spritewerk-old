<!DOCTYPE html>
<html>
<head>
    <title></title>
</head>
<body>
    <canvas></canvas>
    <script src="radio/radio.js"></script>
    <script src="protos.js"></script>
    <script>
        var Config = {
            width: 600,
            height: 400,
            fps: 60
        };

        var Collection = Protos.extend({
            items: {},
            sortedItems: [],

            add: function(name, data) {
                this.items[name] = data;
                this.sortedItems.push(data);
            },

            remove: function(name) {
                var item = this.items[name];

                this.sortedEach(function(iterItem, i) {
                    if (item === iterItem) {
                        iterItem = null;
                        this.sortedItems.splice(i, 1);

                        this.items[name] = null;
                        delete this.items[name];

                        return true;
                    }
                });
            },

            sortedEach: function(fn) {
                for(var i = 0, len = this.sortedItems.length; i < len; i += 1) {
                    fn(this.sortedItems[i], i);
                }
            },

            get: function(name) {
                return this.items[name];
            }
        });

        var Canvas = Protos.extend({
            canvas: null,

            init: function() {
                this.canvas = document.querySelector('canvas');
                this.canvas.width = Config.width;
                this.canvas.height = Config.height;
            },

            getCanvas: function() {
                return this.canvas;
            }
        });

        var Renderable = Protos.extend({
            x: 0,

            y: 0,

            width: null,

            height: null,

            scaleX: 1,

            scaleY: 1,

            rotationOffsetX: 0,

            rotationOffsetY: 0,

            scaleOffsetX: 0,

            scaleOffsetY: 0,

            rotation: 0,

            opacity: 1,

            composite: 'source-over',

            getRight: function() {
                return this.x + this.width;
            },

            getBottom: function() {
                return this.y + this.height;
            },

            getCenterX: function() {
                return this.x + this.halfWidth();
            },

            getCenterY: function() {
                return this.y + this.halfHeight();
            },

            getHalfWidth: function() {
                return this.width / 2;
            },

            getHalfHeight: function() {
                return this.height / 2;
            }
        });

        var Rectangle = Renderable.extend({
            fill: '#000',

            displayType: 'rectangle'
        });

        var Sprite = Renderable.extend({
            img: null,

            displayType: 'sprite',

            init: function() {
                if (this.img) {
                    this.setImage();
                }
            },

            setImage: function(img) {
                this.img = img || this.img;

                if (!this.srcWidth && !this.srcHeight) {
                    this.srcWidth = this.img.width;
                    this.srcHeight = this.img.height;
                }

                if (!this.width && !this.height) {
                    this.width = this.img.width;
                    this.height = this.img.height;
                }
            }
        });

        var Draw = Protos.extend({
            canvas: null,
            context: null,

            init: function() {
                this.canvas = Canvas.getCanvas();
                this.context = this.canvas.getContext('2d');
            },

            clear: function() {
                this.context.clearRect(0, 0, this.canvas.width, this.canvas.height);

                return this;
            },

            fill: function(color) {
                this.context.save();
                this.context.fillStyle = color;
                this.context.fillRect(0, 0, this.canvas.width, this.canvas.height);
                this.context.restore();

                return this;
            },

            render: function(entity) {
                // remember: context transforms are cumulative :)
                this.context.save();
                this.context.translate(entity.x, entity.y);

                if (entity.rotation !== 0) {
                    this.context.translate(entity.rotationOffsetX, entity.rotationOffsetY);
                    this.context.rotate((Math.PI / 180) * entity.rotation);
                    this.context.translate(-entity.rotationOffsetX, -entity.rotationOffsetY);
                }

                if (entity.scaleX !== 1 || entity.scaleY !== 1) {
                    this.context.translate(entity.scaleOffsetX, entity.scaleOffsetY);
                    this.context.scale(entity.scaleX, entity.scaleY);
                    this.context.translate(-entity.scaleOffsetX, -entity.scaleOffsetY);
                }

                this.context.globalAlpha = entity.opacity;
                this.context.globalCompositeOperation = entity.composite;

                switch(entity.displayType) {
                    case 'rectangle':
                        this.renderRectangle(entity);
                    break;
                    case 'sprite':
                        this.renderSprite(entity);
                    break;
                }

                this.context.restore();
            },

            renderRectangle: function(entity) {
                this.context.fillStyle = entity.fill;
                this.context.fillRect(0, 0, entity.width, entity.height);
            },

            renderSprite: function(entity) {
                this.context.drawImage(
                    entity.image,
                    entity.srcX,
                    entity.srcY,
                    entity.srcWidth,
                    entity.srcHeight,
                    0, 0,
                    entity.width,
                    entity.height
                );
            }
        });

        var Preloader = Protos.extend({
            assets: null,

            total: 0,

            loaded: 0,

            /**
             * @params {object}        options
             * @params {array}         options.assets - array of url paths
             */
            init : function(options) {
                var prop;

                this.assets = options.assets;

                for(prop in this.assets) {
                    this.total += 1;
                }

                for (prop in this.assets) {
                    if (this.assets[prop].indexOf('.png') > 0 || this.assets[prop].indexOf('.jpg') > 0) {
                        var img = new Image();
                        img.src = this.assets[prop];

                        radio.tuneIn(img, 'load',  this.loadHandler, this);
                        radio.tuneIn(img, 'error', this.error, this);
                    } else if (this.assets[prop].indexOf('.mp3') > 0 || this.assets[prop].indexOf('.wav') > 0 || this.assets[prop].indexOf('.ogg') > 0) {
                        var audio = new Audio();
                        audio.src = this.assets[prop];

                        radio.tuneIn(audio, 'canplaythrough', this.loadHandler, this);
                        radio.tuneIn(audio, 'error', this.error, this);
                    }
                }
            },

            tuneOutCurrent: function(el) {
                var type = el.tagName.toLowerCase();

                if (type == 'img') {
                    radio.tuneOut(el, 'load',  this.loadHandler);
                    radio.tuneOut(el, 'error', this.error);

                    if (this.MediaManager) {
                        for(var name in this.assets) {
                            if (this.getFileName(this.assets[name]) === this.getFileName(el.src)) {
                                this.MediaManager.addImage(name, el);
                            }
                        }
                    }
                } else if (type == 'audio') {
                    radio.tuneOut(el, 'canplaythrough', this.loadHandler);
                    radio.tuneOut(el, 'error', this.error);

                    if (this.MediaManager) {
                        for(var name in this.assets) {
                            if (this.getFileName(this.assets[name]) === this.getFileName(el.src)) {
                                this.MediaManager.addSound(name, el);
                            }
                        }
                    }
                }
            },

            loadHandler: function(e) {
                this.tuneOutCurrent(e.currentTarget);

                this.loaded += 1;

                if (this.loaded === this.total) {
                    radio.broadcast('preloadcomplete');
                } else {
                    radio.broadcast('preloadupdate', {
                        detail: {
                            loaded: this.loaded,
                            total : this.total
                        }
                    });
                }
            },

            error: function(e) {
                console.log(e.status);
            },

            getFileName: function(path) {
                return path.substring(path.lastIndexOf('/') + 1, path.length + 1);
            }
        });

        var MediaManager = Protos.extend({
            images: {},

            sounds: {},

            addImage: function(name, img) {
                this.images[name] = img;
            },

            addSound: function(name, snd) {
                this.sounds[name] = snd;
            },

            play: function(name) {
                var sound = this.sounds[name];
                
                sound.currentTime = 0;
                sound.play();
            },

            pause: function(name) {
                var sound = this.sounds[name];

                sound.pause();
            },

            resume: function() {
                var sound = this.sounds[name];

                sound.play();
            },

            pauseAll: function() {
                for(var sound in this.sounds) {
                    this.sounds[sound].pause();
                }
            }
        });

        var Game = Protos.extend({
            frame: 0,

            start: function(name, state) {
                if (name && state) {
                    FSM.add(name, state);
                }

                this.scopedUpdate = this.update.bind(this);

                this.update();
            },

            update: function() {
                FSM.sortedEach(function(state) {
                    Draw.clear();

                    if (state.active) {
                        state.update();
                    }

                    if (state.visible) {
                        Draw.clear().fill(state.config.bgColor);

                        state.sortedEach(function(group) {
                            group.sortedEach(function(entity) {
                                Draw.render(entity);
                            });
                        });
                    }
                });

                radio.broadcast('newframe', {
                    detail: {
                        frame: ++this.frame
                    }
                });

                requestAnimationFrame(this.scopedUpdate);
            }
        });

        var FSM = Collection.extend({
            beingLoaded: {
                name: null,
                data: null
            },

            init: function(options) {
                this.add('loading', options.state);

                radio.tuneIn('preloadcomplete', this.onPreloadComplete, this);
            },

            add: function(name, State) {
                if (this.get('loading')) {
                    this.setActive('loading');
                }

                this.beingLoaded.name = name;
                this.beingLoaded.state = new State();

                if (this.beingLoaded.state.assets) {
                    new Preloader({
                        assets: this.beingLoaded.state.assets
                    });
                } else {
                    this.onPreloadComplete();
                }
            },

            onPreloadComplete: function() {
                var state = this.beingLoaded.state;
                var data = state.data;
                var group;
                var entity;
                var entityData;
                var entityName;

                this.sortedEach(function(item) {
                    item.active = false;
                    item.visible = false;
                });

                state.config = data.config;


                for(var g = 0, gLen = data.groups.length; g < gLen; g += 1) {
                    group = data.groups[g];
                    state.add(group.name, new Collection());

                    for(var e = 0, eLen = group.entities.length; e < eLen; e += 1) {
                        entityData = group.entities[e];

                        if (entityData.config.imageName) {
                            entityData.config.img = MediaManager.images[entityData.config.imageName];
                        }

                        entity = new entityData.type(entityData.config);
                        entityName = entityData.name ? entityData.name : entity.displayType + entity._uid;

                        state.get(group.name).add(entityName, entity);
                    }
                }

                state.data = null;
                delete state.data;

                Collection.prototype.add.call(this, this.beingLoaded.name, state);
            },

            setActive: function(name) {
                var state = this.items[name];

                this.sortedEach(function(item, i) {
                    if (state === item) {
                        item.active = true;
                        item.visible = true;
                        this.sortedStates.splice(i, 1);
                        this.sortedStates.push(item);
                    } else {
                        item.active = false;
                        item.visible = false;
                    }
                });
            }
        });

        var State = Collection.extend({
            active: true,

            visible: true,

            data: null,

            init: function() {
                radio.tuneIn('inputreceived', this.inputHandler, this);
            },

            inputHandler: function(e) {
                if (this.active) {
                    // normalize event

                    switch(e.type) {
                        case 'click':
                            //
                        break;
                    }
                }
            },

            update: function() {},

            destroy: function() {
                radio.tuneOut('inputreceived', this.inputHandler);
            }
        });

        var Loading = State.extend({
            data: {
                assets: {
                    sunset: '256.jpg'
                },

                config: {
                    bgColor: '#C3C'
                },

                groups: [
                    {
                        name: 'main',
                        entities: [
                            {
                                name: 'spinnerA',
                                type: Rectangle,
                                config: {
                                    x: 288,
                                    y: 176,
                                    rotationOffsetX: 12,
                                    rotationOffsetY: 36,
                                    width: 24,
                                    height: 24,
                                    fill: '#3C3'
                                }
                            }, {
                                name: 'spinnerB',
                                type: Rectangle,
                                config: {
                                    x: 288,
                                    y: 224,
                                    rotationOffsetX: 12,
                                    rotationOffsetY: -12,
                                    width: 24,
                                    height: 24,
                                    fill: '#3C3'
                                }
                            }
                        ]
                    }
                ]
            },

            update: function() {
                var spinnerA = this.get('main').get('spinnerA');
                var spinnerB = this.get('main').get('spinnerB');

                spinnerA.x += Math.sin(spinnerA.rotation) * 24;

                spinnerA.rotation += 4;
                spinnerB.rotation += 4;
            }
        });

        function init() {
            radio.tuneOut(window, 'load', init);

            MediaManager = new MediaManager();
            Canvas = new Canvas();
            Draw = new Draw();
            FSM = new FSM({
                state: Loading
            });
            Game = new Game();

            Game.start();
        };

        radio.tuneIn(window, 'load', init);
    </script>
</body>
</html>